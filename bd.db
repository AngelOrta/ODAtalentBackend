use oda;

CREATE TABLE Usuario (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    correo VARCHAR(320) NOT NULL UNIQUE,
    rol ENUM('admin', 'alumno', 'reclutador'),
    genero ENUM('masculino', 'femenino', 'otro'),
    uid_firebase VARCHAR(128) NOT NULL UNIQUE,
    url_foto_perfil VARCHAR(400),
);

alter table Usuario modify column uid_firebase VARCHAR(128) UNIQUE;
drop index uid_firebase_2 on Usuario;
alter table Usuario add column url_foto_perfil VARCHAR(400);

CREATE TABLE AlumnoSolicitante (
    id_alumno INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    completado tinyint DEFAULT 0,    ##si el perfil esta completado
    fecha_nacimiento DATE,
    ultimo_acceso TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    descripcion VARCHAR(1500),
    url_cv VARCHAR(400),
    ciudad VARCHAR(100),
    entidad VARCHAR(50), ## ##########
    telefono VARCHAR(15),
    visualizaciones INT DEFAULT 0,
    semestre_actual ENUM('1','2','3','4','5','6','7','8','9','10','11','12'),

    FOREIGN KEY (id_usuario) REFERENCES Usuario(id) ON DELETE CASCADE
);

ALTER TABLE AlumnoSolicitante ADD COLUMN entidad VARCHAR(50);
ALTER TABLE AlumnoSolicitante MODIFY COLUMN semestre_actual ENUM('1','2','3','4','5','6','7','8','9','10','11','12');

CREATE TABLE Escolaridad (
    id_escolaridad INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    nivel ENUM('Bachillerato General','Tecnólogo','Bachillerato Tecnológico','Profesional Técnico','Técnico Superior Universitario', 'Licenciatura') NOT NULL,
    institucion VARCHAR(200) NOT NULL,
    carrera VARCHAR(200),
    plantel VARCHAR(160) NOT NULL,
    nota ENUM('Pasante', 'Titulado', 'Egresado', 'Cursando', 'Trunca') NOT NULL,
    fecha_inicio YEAR NOT NULL,
    fecha_fin YEAR NOT NULL,

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

ALTER TABLE escolaridad
ADD CONSTRAINT unique_escolaridad_alumno
UNIQUE (id_alumno, nivel, institucion, carrera ,plantel);

CREATE TABLE URLExterna (
    id_url INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    url VARCHAR(400) NOT NULL,
    tipo ENUM('LinkedIn', 'GitHub', 'Blog', 'Portafolio', 'Otro') NOT NULL,

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

ALTER TABLE URLExterna
ADD CONSTRAINT unique_url_alumno
UNIQUE (id_alumno, url, tipo);


CREATE TABLE Curso (
    id_curso INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    nombre VARCHAR(200) NOT NULL,
    institucion VARCHAR(200) NOT NULL,
    fecha_inicio DATE NOT NULL,
    fecha_fin DATE NOT NULL,

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

ALTER TABLE Curso
ADD CONSTRAINT unique_curso_alumno
UNIQUE (id_alumno, nombre, institucion, fecha_inicio, fecha_fin);

CREATE TABLE Habilidad (
    id_habilidad INT AUTO_INCREMENT PRIMARY KEY,
    habilidad VARCHAR(100) NOT NULL,
    categoria ENUM('Comunicación','Interpersonales', 'Pensamiento y Resolución','Autogestión', 'Carácter y Ética') NOT NULL, ##Caracter y Etica
    tipo ENUM('Blandas', 'Técnicas', 'Idioma') NOT NULL
);

CREATE TABLE Certificado(
    id_certificado INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    nombre VARCHAR(200) NOT NULL,
    institucion VARCHAR(200) NOT NULL, ##empresa o institucion que lo otorga
    fecha_expedicion DATE NOT NULL,
    fecha_caducidad DATE,
    id_credencial VARCHAR(100), ##numero de credencial o folio
    url_certificado VARCHAR(400),

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

ALTER TABLE Certificado
ADD CONSTRAINT unique_certificado_alumno
UNIQUE (id_alumno, nombre, institucion, fecha_expedicion);

CREATE TABLE Certificado_Habilidad (
    id_certificado INT NOT NULL,
    id_habilidad INT NOT NULL,
    PRIMARY KEY (id_certificado, id_habilidad),

    FOREIGN KEY (id_certificado) REFERENCES Certificado(id_certificado) ON DELETE CASCADE,
    FOREIGN KEY (id_habilidad) REFERENCES Habilidad(id_habilidad) ON DELETE CASCADE
);

CREATE TABLE Experiencia(
    id_experiencia INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    cargo VARCHAR(100) NOT NULL,
    empresa VARCHAR(100) NOT NULL,
    fecha_inicio DATE NOT NULL,
    fecha_fin DATE,
    descripcion VARCHAR(2000),

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

ALTER TABLE experiencia
ADD CONSTRAINT unique_experiencia_alumno
UNIQUE (id_alumno, cargo, empresa, fecha_inicio);

CREATE TABLE Experiencia_Habilidad (
    id_experiencia INT NOT NULL,
    id_habilidad INT NOT NULL,
    PRIMARY KEY (id_experiencia, id_habilidad),

    FOREIGN KEY (id_experiencia) REFERENCES Experiencia(id_experiencia) ON DELETE CASCADE,
    FOREIGN KEY (id_habilidad) REFERENCES Habilidad(id_habilidad) ON DELETE CASCADE
);

CREATE TABLE Alumno_Habilidad (
    id_alumno INT NOT NULL,
    id_habilidad INT NOT NULL,
    PRIMARY KEY (id_alumno, id_habilidad),

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE,
    FOREIGN KEY (id_habilidad) REFERENCES Habilidad(id_habilidad) ON DELETE CASCADE
);

CREATE TABLE Empresa (
    id_empresa INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(20) NOT NULL,
    descripcion VARCHAR(2000) NOT NULL,
    url_logo VARCHAR(400),
    sitio_web VARCHAR(400),
    ##inicio_direccion (calle, numero, colonia)
    ##fin_direccion (ciudad, estado, codigo_postal)
);

ALTER TABLE Empresa ADD COLUMN sitio_web VARCHAR(400);
ALTER TABLE Empresa modify column nombre VARCHAR(20) NOT NULL UNIQUE;


CREATE TABLE Reclutador (
    id_reclutador INT AUTO_INCREMENT PRIMARY KEY,
    id_empresa INT NOT NULL,
    id_usuario INT NOT NULL,

    FOREIGN KEY (id_empresa) REFERENCES Empresa(id_empresa),
    FOREIGN KEY (id_usuario) REFERENCES Usuario(id) ON DELETE CASCADE
);

ALTER TABLE Reclutador ADD COLUMN estado ENUM('Pendiente', 'Aprobado') DEFAULT 'Pendiente';

CREATE TABLE Vacante (
    id_vacante INT AUTO_INCREMENT PRIMARY KEY,
    id_reclutador INT NOT NULL,
    titulo VARCHAR(255) NOT NULL,
    descripcion VARCHAR(4000) NOT NULL,
    beneficios VARCHAR(1500),
    fecha_inicio DATE,
    fecha_fin DATE,
    duracion VARCHAR(12) NOT NULL,
    monto_beca DECIMAL(10,2) NOT NULL,
    horario VARCHAR(100) NOT NULL,
    ubicacion VARCHAR(400) NOT NULL,
    ciudad VARCHAR(50) NOT NULL,
    entidad VARCHAR(50) NOT NULL,
    codigo_postal MEDIUMINT,
    modalidad ENUM('Presencial', 'Remoto', 'Híbrido') NOT NULL,
    fecha_limite DATE,
    fecha_publicacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    escolaridad VARCHAR(50) NOT NULL, ##semestre minimo, ej. Minimo 6, 7 semestre
    conocimientos VARCHAR(1000), ##habilidades tecnicas
    observaciones VARCHAR(400),
    numero_vacantes INT NOT NULL,
    estado ENUM('Activa', 'Expirada') DEFAULT 'Activa',

    FOREIGN KEY (id_reclutador) REFERENCES Reclutador(id_reclutador) ON DELETE CASCADE
);

CREATE TABLE Vacante_Habilidad (
    id_vacante INT NOT NULL,
    id_habilidad INT NOT NULL,
    PRIMARY KEY (id_vacante, id_habilidad),

    FOREIGN KEY (id_vacante) REFERENCES Vacante(id_vacante) ON DELETE CASCADE,
    FOREIGN KEY (id_habilidad) REFERENCES Habilidad(id_habilidad) ON DELETE CASCADE
);

CREATE TABLE Postulacion (
    id_postulacion INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    id_vacante INT NOT NULL,
    ##fecha_postulacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    estatus ENUM('En revisión', 'Reclutado', 'Rechazado', 'Completado') DEFAULT 'En revisión',

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE,
    FOREIGN KEY (id_vacante) REFERENCES Vacante(id_vacante) ON DELETE CASCADE
);

CREATE TABLE RolTrabajo (
    id_roltrabajo INT AUTO_INCREMENT PRIMARY KEY,
    area VARCHAR(50) NOT NULL,
    nombre VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE Vacante_RolTrabajo (
    id_vacante INT NOT NULL,
    id_roltrabajo INT NOT NULL,
    PRIMARY KEY (id_vacante, id_roltrabajo),

    FOREIGN KEY (id_vacante) REFERENCES Vacante(id_vacante) ON DELETE CASCADE,
    FOREIGN KEY (id_roltrabajo) REFERENCES RolTrabajo(id_roltrabajo) ON DELETE CASCADE
);

CREATE TABLE Reporte (
    id_reporte INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT,
    id_reclutador INT,
    id_contenido INT NOT NULL, ##publicacion, comentario, vacante, perfil?
    tipo_contenido ENUM( 'Vacante', 'Publicacion', 'Comentario') NOT NULL,
    razon ENUM('Contenido inapropiado', 'Sin vacantes', 'Otro') NOT NULL,
    descripcion VARCHAR(255), ##motivo
    fecha_reporte TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    estado ENUM('En espera', 'Resuelto') DEFAULT 'En espera',
    comentario_admin VARCHAR(100),

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE,
    FOREIGN KEY (id_reclutador) REFERENCES Reclutador(id_reclutador) ON DELETE CASCADE
);

CREATE TABLE Publicacion (
    id_publicacion INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    ##id_reclutador INT NOT NULL,
    titulo VARCHAR(200) NOT NULL,
    contenido VARCHAR(5000) NOT NULL,
    fecha_publicacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    reacciones INT DEFAULT 0,
    url_multimedia VARCHAR(400),

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
    ##FOREIGN KEY (id_reclutador) REFERENCES Reclutador(id_reclutador) ON DELETE CASCADE
);

CREATE TABLE Publicacion_RolTrabajo (
    id_publicacion INT NOT NULL,
    id_roltrabajo INT NOT NULL,
    PRIMARY KEY (id_publicacion, id_roltrabajo),

    FOREIGN KEY (id_publicacion) REFERENCES Publicacion(id_publicacion) ON DELETE CASCADE,
    FOREIGN KEY (id_roltrabajo) REFERENCES RolTrabajo(id_roltrabajo) ON DELETE CASCADE
);

CREATE TABLE Publicacion_Reacciones (
    id_publicacion INT NOT NULL,
    id_alumno INT NOT NULL,
    tipo_reaccion ENUM('upvote', 'downvote') NOT NULL,
    PRIMARY KEY (id_publicacion, id_alumno),

    FOREIGN KEY (id_publicacion) REFERENCES Publicacion(id_publicacion) ON DELETE CASCADE,
    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

CREATE TABLE Comentario (
    id_comentario INT AUTO_INCREMENT PRIMARY KEY,
    id_publicacion INT NOT NULL,
    id_alumno INT NOT NULL,
    id_comentario_padre INT,
    ##id_reclutador INT NOT NULL,
    contenido VARCHAR(280) NOT NULL, ##como un twit
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    reacciones INT DEFAULT 0,

    FOREIGN KEY (id_publicacion) REFERENCES Publicacion(id_publicacion) ON DELETE CASCADE,
    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE,
    FOREIGN KEY (id_comentario_padre) REFERENCES Comentario(id_comentario) ON DELETE CASCADE
    ##FOREIGN KEY (id_reclutador) REFERENCES Reclutador(id_reclutador) ON DELETE CASCADE
);

CREATE TABLE Comentario_Reacciones (
    id_comentario INT NOT NULL,
    id_alumno INT NOT NULL,
    tipo_reaccion ENUM('upvote', 'downvote') NOT NULL,
    PRIMARY KEY (id_comentario, id_alumno),

    FOREIGN KEY (id_comentario) REFERENCES Comentario(id_comentario) ON DELETE CASCADE,
    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

CREATE TABLE Busqueda (
    id_busqueda INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    consulta VARCHAR(100) NOT NULL,
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE
);

CREATE TABLE Articulo ( ##tambien usado para FAQS
    id_articulo INT AUTO_INCREMENT PRIMARY KEY,
    id_admin INT NOT NULL,
    titulo VARCHAR(100) NOT NULL,
    id_roltrabajo INT,
    contenido TEXT(65535) NOT NULL,

    FOREIGN KEY (id_admin) REFERENCES Usuario(id)
);

CREATE TABLE Conversacion (
    id_conversacion INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    id_reclutador INT NOT NULL,
    fecha_creacion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (id_alumno) REFERENCES AlumnoSolicitante(id_alumno) ON DELETE CASCADE,
    FOREIGN KEY (id_reclutador) REFERENCES Reclutador(id_reclutador) ON DELETE CASCADE
);

CREATE TABLE Mensaje (
    id_mensaje INT AUTO_INCREMENT PRIMARY KEY,
    id_conversacion INT NOT NULL,
    id_emisor INT NOT NULL,
    fecha_enviado TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    contenido VARCHAR(500) NOT NULL,
    fecha_leido TIMESTAMP,

    FOREIGN KEY (id_conversacion) REFERENCES Conversacion(id_conversacion) ON DELETE CASCADE,
    FOREIGN KEY (id_emisor) REFERENCES Usuario(id) ON DELETE CASCADE
);

CREATE TABLE Notificacion (
    id_notificacion INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    titulo VARCHAR(70) NOT NULL,
    cuerpo VARCHAR(255) NOT NULL,
    url_icono VARCHAR(400) NOT NULL,
    tipo ENUM('Vacante', 'Conversacion', 'Reporte', 'Configuracion') NOT NULL, ##para saber a donde redirigir cuando se de tap en la notificacion
    id_tipo INT NOT NULL, ##id de la vacante, conversacion, reporte, etc.
    fecha TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    leido TINYINT DEFAULT 0,

    FOREIGN KEY (id_usuario) REFERENCES Usuario(id) ON DELETE CASCADE
);

CREATE TABLE FCMToken (
    id_token INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    dispositivo ENUM('android', 'ios', 'web') NOT NULL,
    token VARCHAR(255) UNIQUE NOT NULL,

    FOREIGN KEY (id_usuario) REFERENCES Usuario(id) ON DELETE CASCADE
);

CREATE TABLE FAQS (
    id_faq INT AUTO_INCREMENT PRIMARY KEY,
    id_admin INT NOT NULL,      
    pregunta VARCHAR(255) NOT NULL,
    respuesta TEXT NOT NULL,
    orden INT DEFAULT 0,    
    
    FOREIGN KEY (id_admin) REFERENCES Usuario(id)
);